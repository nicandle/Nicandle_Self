-- 目标：任务进度对照表——按任务、按首日/次日统计完成人数及各项平均值
-- 数据库：nvwa_cbt1
-- 引擎：Spark SQL（无 WITH 语法，使用子查询）
-- 筛选条件：注册日期 20260129~20260130，IP 区域为 BR 或 ID；首日=注册当日完成，次日=注册次日完成

SELECT 
    task_id as `任务ID`,
    count(distinct account_id) as `用户人数`,
    count(distinct case when day_type = 1 then account_id end) as `首日完成人数`,
    round(avg(case when day_type = 1 then hatch_count end), 2) as `首日平均孵化次数`,
    round(avg(case when day_type = 1 then pet_level_max end), 2) as `首日平均宠物等级`,
    round(avg(case when day_type = 1 then home_level_max end), 2) as `首日平均家园等级`,
    round(avg(case when day_type = 1 then exploration_count end), 2) as `首日平均探险次数`,
    count(distinct case when day_type = 2 then account_id end) as `次日完成人数`,
    round(avg(case when day_type = 2 then hatch_count end), 2) as `次日平均孵化次数`,
    round(avg(case when day_type = 2 then pet_level_max end), 2) as `次日平均宠物等级`,
    round(avg(case when day_type = 2 then home_level_max end), 2) as `次日平均家园等级`,
    round(avg(case when day_type = 2 then exploration_count end), 2) as `次日平均探险次数`
FROM (
    SELECT 
        t.task_id,
        t.sort_idx,
        p.account_id,
        case
            when td.completion_dt = p.register_dt then 1
            when td.completion_dt = date_format(date_add(to_date(p.register_dt, 'yyyyMMdd'), 1), 'yyyyMMdd') then 2
            else 0
        end as day_type,
        coalesce(h.hatch_count, 0) as hatch_count,
        coalesce(pl.pet_level_max, 0) as pet_level_max,
        coalesce(hl.home_level_max, 0) as home_level_max,
        coalesce(e.exploration_count, 0) as exploration_count
    FROM (
        SELECT 1010101 as task_id, 1 as sort_idx UNION ALL SELECT 1010102, 2 UNION ALL SELECT 1010201, 3 UNION ALL SELECT 10102011, 4 UNION ALL SELECT 10102012, 5 UNION ALL SELECT 10102013, 6 UNION ALL SELECT 1010202, 7 UNION ALL SELECT 1010301, 8 UNION ALL SELECT 1010302, 9 UNION ALL SELECT 1010303, 10 UNION ALL
        SELECT 1010402, 11 UNION ALL SELECT 1010403, 12 UNION ALL SELECT 10104031, 13 UNION ALL SELECT 1010404, 14 UNION ALL SELECT 10104041, 15 UNION ALL SELECT 10104042, 16 UNION ALL SELECT 10104043, 17 UNION ALL SELECT 1010501, 18 UNION ALL SELECT 1010502, 19 UNION ALL SELECT 1010503, 20 UNION ALL SELECT 1010504, 21 UNION ALL
        SELECT 1010601, 22 UNION ALL SELECT 1010602, 23 UNION ALL SELECT 1010603, 24 UNION ALL SELECT 1010604, 25 UNION ALL SELECT 1010605, 26 UNION ALL SELECT 1010701, 27 UNION ALL SELECT 1010702, 28 UNION ALL SELECT 1010703, 29 UNION ALL SELECT 10107031, 30 UNION ALL SELECT 10107032, 31 UNION ALL
        SELECT 1010801, 32 UNION ALL SELECT 1010802, 33 UNION ALL SELECT 1010803, 34 UNION ALL SELECT 1010901, 35 UNION ALL SELECT 1010902, 36 UNION ALL SELECT 10109021, 37 UNION ALL SELECT 10109022, 38 UNION ALL SELECT 1010903, 39 UNION ALL SELECT 1010904, 40 UNION ALL SELECT 1010905, 41 UNION ALL
        SELECT 1011001, 42 UNION ALL SELECT 1011002, 43 UNION ALL SELECT 1011003, 44 UNION ALL SELECT 1011004, 45 UNION ALL SELECT 1011101, 46 UNION ALL SELECT 10111011, 47 UNION ALL SELECT 1011102, 48 UNION ALL SELECT 1011103, 49 UNION ALL SELECT 1011104, 50 UNION ALL SELECT 1011105, 51 UNION ALL
        SELECT 1011201, 52 UNION ALL SELECT 1011202, 53 UNION ALL SELECT 1011203, 54 UNION ALL SELECT 1011301, 55 UNION ALL SELECT 1011302, 56 UNION ALL SELECT 1011303, 57 UNION ALL SELECT 1011304, 58 UNION ALL SELECT 1011305, 59 UNION ALL SELECT 10113051, 60 UNION ALL SELECT 1011306, 61 UNION ALL
        SELECT 1011401, 62 UNION ALL SELECT 1011402, 63 UNION ALL SELECT 1011403, 64 UNION ALL SELECT 1011404, 65 UNION ALL SELECT 1011405, 66 UNION ALL SELECT 1011501, 67 UNION ALL SELECT 1011502, 68 UNION ALL SELECT 1011503, 69 UNION ALL SELECT 10115031, 70 UNION ALL
        SELECT 1011601, 71 UNION ALL SELECT 1011602, 72 UNION ALL SELECT 1011603, 73 UNION ALL SELECT 1011604, 74 UNION ALL SELECT 1011605, 75 UNION ALL SELECT 1011606, 76 UNION ALL SELECT 1011701, 77 UNION ALL SELECT 10117011, 78 UNION ALL SELECT 1011702, 79 UNION ALL SELECT 1011703, 80 UNION ALL SELECT 1011704, 81 UNION ALL SELECT 1011705, 82 UNION ALL
        SELECT 1011801, 83 UNION ALL SELECT 1011802, 84 UNION ALL SELECT 1011803, 85 UNION ALL SELECT 1011804, 86 UNION ALL SELECT 1011805, 87 UNION ALL SELECT 1011901, 88 UNION ALL SELECT 1011902, 89 UNION ALL SELECT 10119021, 90 UNION ALL SELECT 1011903, 91 UNION ALL SELECT 1011904, 92 UNION ALL SELECT 1011905, 93 UNION ALL SELECT 1011906, 94 UNION ALL
        SELECT 1012001, 95 UNION ALL SELECT 1012002, 96 UNION ALL SELECT 1012003, 97 UNION ALL SELECT 1012004, 98 UNION ALL SELECT 10120041, 99 UNION ALL
        SELECT 1012101, 100 UNION ALL SELECT 1012102, 101 UNION ALL SELECT 1012103, 102 UNION ALL SELECT 1012104, 103 UNION ALL SELECT 1012105, 104 UNION ALL SELECT 1012201, 105 UNION ALL SELECT 1012202, 106 UNION ALL
        SELECT 1012301, 107 UNION ALL SELECT 1012302, 108 UNION ALL SELECT 1012303, 109 UNION ALL SELECT 1012304, 110 UNION ALL SELECT 1012305, 111 UNION ALL SELECT 1012401, 112 UNION ALL SELECT 1012402, 113 UNION ALL SELECT 10124021, 114 UNION ALL SELECT 1012403, 115 UNION ALL SELECT 1012404, 116 UNION ALL SELECT 1012405, 117 UNION ALL
        SELECT 1012501, 118 UNION ALL SELECT 1012502, 119 UNION ALL SELECT 1012503, 120 UNION ALL SELECT 10125031, 121 UNION ALL SELECT 1012504, 122 UNION ALL SELECT 1012601, 123 UNION ALL SELECT 1012602, 124 UNION ALL SELECT 1012603, 125 UNION ALL SELECT 1012604, 126 UNION ALL SELECT 1012605, 127 UNION ALL SELECT 1012606, 128 UNION ALL
        SELECT 1012701, 129 UNION ALL SELECT 1012702, 130 UNION ALL SELECT 1012703, 131 UNION ALL SELECT 1012704, 132 UNION ALL SELECT 1012705, 133 UNION ALL SELECT 1012801, 134 UNION ALL SELECT 1012802, 135 UNION ALL SELECT 1012803, 136 UNION ALL SELECT 1012804, 137 UNION ALL SELECT 1012805, 138 UNION ALL
        SELECT 1012901, 139 UNION ALL SELECT 1012902, 140 UNION ALL SELECT 1012903, 141 UNION ALL SELECT 1012904, 142 UNION ALL SELECT 1013001, 143 UNION ALL SELECT 1013002, 144 UNION ALL SELECT 1013003, 145 UNION ALL SELECT 1013004, 146 UNION ALL
        SELECT 1013101, 147 UNION ALL SELECT 1013102, 148 UNION ALL SELECT 1013103, 149 UNION ALL SELECT 1013104, 150 UNION ALL SELECT 1013105, 151
    ) t
    INNER JOIN (
        SELECT account_id, task_id, substring(cast(local_dt_srv as string), 1, 8) as completion_dt
        FROM nvwa_cbt1.taskaction
        WHERE local_dt_srv >= '20260129' AND task_action = 2
    ) td ON t.task_id = td.task_id
    INNER JOIN (
        SELECT account_id, ip_region as region, dt as register_dt
        FROM nvwa_cbt1.accountregister
        WHERE dt BETWEEN '20260129' AND '20260130' AND ip_region IN ('BR', 'ID')
    ) p ON td.account_id = p.account_id
    LEFT JOIN (
        SELECT account_id, count(*) as hatch_count
        FROM nvwa_cbt1.PetCreateCustom
        WHERE local_dt_srv >= '20260129'
        GROUP BY account_id
    ) h ON p.account_id = h.account_id
    LEFT JOIN (
        SELECT account_id, max(pet_level) as pet_level_max
        FROM (
            SELECT account_id, pet_id, max(pet_level) as pet_level
            FROM nvwa_cbt1.petlevelup
            WHERE local_dt_srv >= '20260129'
            GROUP BY account_id, pet_id
        ) t2
        GROUP BY account_id
    ) pl ON p.account_id = pl.account_id
    LEFT JOIN (
        SELECT account_id, max(building_level) as home_level_max
        FROM nvwa_cbt1.homebuild
        WHERE local_dt_srv >= '20260129'
        GROUP BY account_id
    ) hl ON p.account_id = hl.account_id
    LEFT JOIN (
        SELECT account_id, count(*) as exploration_count
        FROM nvwa_cbt1.exploration
        WHERE local_dt_srv >= '20260129'
        GROUP BY account_id
    ) e ON p.account_id = e.account_id
) x
GROUP BY task_id, sort_idx
ORDER BY sort_idx ASC;
